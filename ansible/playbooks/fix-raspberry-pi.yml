---
# Playbook: Fix Raspberry Pi Broken Packages
# This playbook fixes the common Raspberry Pi issue where /boot/firmware is read-only
# causing package installation failures

- name: Fix Raspberry Pi Boot Partition and Broken Packages
  hosts: homelab_servers
  become: true

  tasks:
    - name: Check if this is a Raspberry Pi
      ansible.builtin.stat:
        path: /boot/firmware
      register: boot_firmware

    - name: Skip if not Raspberry Pi
      ansible.builtin.debug:
        msg: "Not a Raspberry Pi system, skipping..."
      when: not boot_firmware.stat.exists

    - name: Check if boot partition is read-only
      ansible.builtin.shell: |
        mount | grep '/boot/firmware' | grep -q 'ro,' && echo "readonly" || echo "readwrite"
      register: boot_mount_status
      changed_when: false
      when: boot_firmware.stat.exists

    - name: Display boot partition status
      ansible.builtin.debug:
        msg: "Boot partition is: {{ boot_mount_status.stdout }}"
      when: boot_firmware.stat.exists

    - name: Remount boot partition as read-write
      ansible.builtin.command: mount -o remount,rw /boot/firmware
      when:
        - boot_firmware.stat.exists
        - boot_mount_status.stdout == "readonly"
      register: remount_result

    - name: Confirm remount successful
      ansible.builtin.debug:
        msg: "✅ Boot partition remounted as read-write"
      when: remount_result is changed

    - name: Fix broken packages (dpkg --configure -a)
      ansible.builtin.command: dpkg --configure -a
      environment:
        DEBIAN_FRONTEND: noninteractive
      when: boot_firmware.stat.exists
      register: dpkg_fix
      changed_when: "'Setting up' in dpkg_fix.stdout"
      failed_when: false

    - name: Display dpkg fix result
      ansible.builtin.debug:
        msg: "{{ dpkg_fix.stdout_lines | default(['No broken packages']) }}"
      when: boot_firmware.stat.exists

    - name: Clean up any remaining issues
      ansible.builtin.apt:
        autoremove: yes
        autoclean: yes
      when: boot_firmware.stat.exists
      environment:
        DEBIAN_FRONTEND: noninteractive

    - name: Check for remaining broken packages
      ansible.builtin.command: dpkg -l | grep -E '^iU|^iF' || true
      register: broken_packages
      changed_when: false
      when: boot_firmware.stat.exists

    - name: Display remaining issues (if any)
      ansible.builtin.debug:
        msg: "{{ broken_packages.stdout_lines if broken_packages.stdout else ['✅ No broken packages remaining'] }}"
      when: boot_firmware.stat.exists

    - name: Remount boot partition as read-only (optional, for safety)
      ansible.builtin.command: mount -o remount,ro /boot/firmware
      when:
        - boot_firmware.stat.exists
        - remount_result is changed
      failed_when: false
      register: remount_ro

    - name: Display final status
      ansible.builtin.debug:
        msg:
          - "✅ Raspberry Pi package system fixed!"
          - ""
          - "Boot partition: {{ 'remounted read-only' if remount_ro is changed else 'left read-write' }}"
          - ""
          - "You can now run other playbooks:"
          - "  ansible-playbook playbooks/fail2ban.yml -K --limit homelab_secondary"
          - "  ansible-playbook playbooks/maintenance.yml -K --limit homelab_secondary"
          - ""
          - "Note: If you need to install more packages, remount as read-write first:"
          - "  sudo mount -o remount,rw /boot/firmware"
      when: boot_firmware.stat.exists
