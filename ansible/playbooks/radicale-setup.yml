---
# Playbook: Radicale CalDAV/CardDAV Setup
# This playbook creates user accounts for Radicale server
# Run this after deploying Radicale service

- name: Setup Radicale Users
  hosts: homelab_servers
  become: false

  vars:
    radicale_config_path: "{{ apps_path }}/.volumes/radicale/config"
    radicale_users_file: "{{ radicale_config_path }}/users"

  tasks:
    # ===== Verify Radicale is Running =====
    - name: Check if Radicale container is running
      ansible.builtin.command: docker ps --filter "name=radicale" --format "{{{{.Names}}}}"
      register: radicale_running
      changed_when: false
      failed_when: false

    - name: Fail if Radicale is not running
      ansible.builtin.fail:
        msg: |
          ❌ Radicale container is not running!
          
          Please deploy Radicale first:
            ansible-playbook playbooks/deploy.yml
      when: "'radicale' not in radicale_running.stdout"

    # ===== Check Configuration =====
    - name: Check if Radicale config directory exists
      ansible.builtin.stat:
        path: "{{ radicale_config_path }}"
      register: config_dir

    - name: Create Radicale config directory if missing
      ansible.builtin.file:
        path: "{{ radicale_config_path }}"
        state: directory
        owner: "{{ homelab_user }}"
        group: "{{ homelab_user }}"
        mode: "0755"
      when: not config_dir.stat.exists

    - name: Check if users file exists
      ansible.builtin.stat:
        path: "{{ radicale_users_file }}"
      register: users_file

    - name: Display users file status
      ansible.builtin.debug:
        msg: |
          Users file exists: {{ users_file.stat.exists }}
          Path: {{ radicale_users_file }}

    # ===== User Creation =====
    - name: Prompt for username
      ansible.builtin.pause:
        prompt: "Enter username to create/update (or press Ctrl+C to cancel)"
      register: username_input

    - name: Set username variable
      ansible.builtin.set_fact:
        radicale_username: "{{ username_input.user_input }}"

    - name: Check if httpd-tools is installed
      ansible.builtin.command: which htpasswd
      register: htpasswd_check
      failed_when: false
      changed_when: false

    - name: Install httpd-tools if missing
      ansible.builtin.package:
        name: httpd-tools
        state: present
      become: true
      when: htpasswd_check.rc != 0

    - name: Create or update user in Radicale
      ansible.builtin.command: >
        htpasswd -B {{ '-c' if not users_file.stat.exists else '' }} {{ radicale_users_file }} {{ radicale_username }}
      register: htpasswd_result
      changed_when: true
      no_log: false  # Show output for password prompt

    - name: Set correct permissions on users file
      ansible.builtin.file:
        path: "{{ radicale_users_file }}"
        owner: "{{ homelab_user }}"
        group: "{{ homelab_user }}"
        mode: "0600"

    - name: Get list of all users
      ansible.builtin.shell: "cat {{ radicale_users_file }} | cut -d: -f1"
      register: all_users
      changed_when: false

    - name: Restart Radicale container
      ansible.builtin.command: docker restart radicale
      register: restart_result
      changed_when: true

    - name: Wait for Radicale to be healthy
      ansible.builtin.wait_for:
        port: 5232
        delay: 2
        timeout: 10

    # ===== Summary =====
    - name: Display setup summary
      ansible.builtin.debug:
        msg:
          - "✅ Radicale user setup completed!"
          - ""
          - "User: {{ radicale_username }}"
          - "{{ '(new user created)' if not users_file.stat.exists or radicale_username not in all_users.stdout_lines else '(password updated)' }}"
          - ""
          - "All users in system:"
          - "{{ all_users.stdout_lines }}"
          - ""
          - "Radicale container restarted: {{ restart_result.changed }}"
          - ""
          - "Next steps:"
          - "  • Access Radicale: https://cal.{{ lookup('env', 'DOMAIN') }}"
          - "  • Configure Thunderbird:"
          - "      - New Calendar → CalDAV"
          - "      - Location: https://cal.{{ lookup('env', 'DOMAIN') }}/{{ radicale_username }}/"
          - "      - Username: {{ radicale_username }}"
          - "  • Configure Tasks.org (Android):"
          - "      - Add CalDAV account"
          - "      - Server: https://cal.{{ lookup('env', 'DOMAIN') }}"
          - "      - Username: {{ radicale_username }}"
