---
# Unified Deploy Playbook
# Deploy services to any server: home, cloud, or offsite
# Usage: ansible-playbook ansible/playbooks/deploy.yml --limit home|cloud|offsite

- name: Deploy Homelab Services
  hosts: homelab_servers
  become: false

  vars:
    local_repo_path: "{{ playbook_dir }}/../.."
    server_source: "{{ local_repo_path }}/servers/{{ inventory_hostname }}"
    server_path: "{{ apps_path }}"

  pre_tasks:
    - name: Determine server type
      ansible.builtin.set_fact:
        is_home_server: "{{ inventory_hostname == 'home' }}"
        is_cloud_server: "{{ inventory_hostname == 'cloud' }}"
        is_offsite_server: "{{ inventory_hostname == 'offsite' }}"

  tasks:
    # ===== Prerequisites Check =====
    - name: Check if Docker is installed
      ansible.builtin.command: docker --version
      register: docker_check
      failed_when: false
      changed_when: false

    - name: Fail if Docker is not installed
      ansible.builtin.fail:
        msg: |
          ❌ Docker is not installed!
          Run initial setup first: ansible-playbook ansible/playbooks/initial-setup.yml --limit {{ inventory_hostname }}
      when: docker_check.rc != 0

    - name: Check if .env file exists locally
      ansible.builtin.stat:
        path: "{{ local_repo_path }}/.env"
      delegate_to: localhost
      register: env_file

    - name: Fail if .env file is missing
      ansible.builtin.fail:
        msg: |
          ❌ .env file not found!
          Create it from template: cp {{ local_repo_path }}/.env.example {{ local_repo_path }}/.env
      when: not env_file.stat.exists

    # ===== HOME SERVER TASKS =====
    - name: Home Server - Build Homepage
      when: is_home_server
      block:
        - name: Create homepage dist directory locally
          ansible.builtin.file:
            path: "{{ server_source }}/homepage/dist"
            state: directory
            mode: "0755"
          delegate_to: localhost

        - name: Build homepage from template
          ansible.builtin.shell: |
            python3 << 'PYEOF'
            import os, re
            env_vars = {}
            with open('{{ local_repo_path }}/.env', 'r') as f:
                for line in f:
                    line = line.strip()
                    if line and not line.startswith('#') and '=' in line:
                        key, _, value = line.partition('=')
                        env_vars[key.strip()] = value.strip()
            with open('{{ server_source }}/homepage/src/index.html', 'r') as f:
                content = f.read()
            def replace_var(match):
                var_name = match.group(1)
                return env_vars.get(var_name, match.group(0))
            content = re.sub(r'\$([A-Z_]+)', replace_var, content)
            with open('{{ server_source }}/homepage/dist/index.html', 'w') as f:
                f.write(content)
            PYEOF
          args:
            executable: /bin/bash
          delegate_to: localhost
          changed_when: true

        - name: Generate service worker cache version
          ansible.builtin.shell: |
            CACHE_VERSION="$(date +%s)-$(openssl rand -hex 4)"
            sed "s/__CACHE_VERSION__/${CACHE_VERSION}/g" {{ server_source }}/homepage/src/sw.js > {{ server_source }}/homepage/dist/sw.js
          args:
            executable: /bin/bash
          delegate_to: localhost
          changed_when: true

        - name: Copy homepage manifest
          ansible.builtin.copy:
            src: "{{ server_source }}/homepage/src/manifest.json"
            dest: "{{ server_source }}/homepage/dist/manifest.json"
          delegate_to: localhost

        - name: Copy homepage assets
          ansible.builtin.copy:
            src: "{{ server_source }}/homepage/src/assets"
            dest: "{{ server_source }}/homepage/dist/"
          delegate_to: localhost

    # ===== SYNC FILES TO SERVER =====
    - name: Sync server files to remote
      ansible.posix.synchronize:
        src: "{{ server_source }}/"
        dest: "{{ server_path }}/"
        delete: no
        recursive: yes
        rsync_opts:
          - "--include-from={{ server_source }}/deploy.files.txt"
          - "--exclude=*"
          - "-avhzru"

    # ===== DOCKER NETWORK SETUP =====
    - name: Create proxy network
      community.docker.docker_network:
        name: proxy
        state: present

    # ===== DEPLOY MAIN SERVICES =====
    - name: Deploy main services
      ansible.builtin.command:
        cmd: docker compose up -d
        chdir: "{{ server_path }}"
      register: deploy_result
      changed_when: "'Started' in deploy_result.stderr or 'Created' in deploy_result.stderr"

    # ===== HOME SERVER - ADDITIONAL SERVICES =====
    - name: Home Server - Deploy Immich
      when: is_home_server
      block:
        - name: Deploy Immich
          ansible.builtin.command:
            cmd: docker compose --env-file=../.env up -d
            chdir: "{{ server_path }}/immich"
          register: immich_deploy
          changed_when: "'Started' in immich_deploy.stderr or 'Created' in immich_deploy.stderr"

        - name: Read .env for Piped config
          ansible.builtin.slurp:
            src: "{{ server_path }}/.env"
          register: env_content

        - name: Parse .env variables
          ansible.builtin.set_fact:
            env_vars: "{{ dict((env_content.content | b64decode).split('\n') | select('match', '^[A-Z_]+=') | map('regex_replace', '^([A-Z_]+)=(.*)$', '\\1||\\2') | map('split', '||')) }}"

        - name: Generate Piped config
          ansible.builtin.template:
            src: "{{ server_source }}/piped/config.properties.j2"
            dest: "{{ server_path }}/piped/config.properties"
            mode: "0644"
          vars:
            DOMAIN: "{{ env_vars.HOME_DOMAIN }}"
            PIPED_DB_NAME: "{{ env_vars.HOME_PIPED_DB_NAME }}"
            PIPED_DB_USER: "{{ env_vars.HOME_PIPED_DB_USER }}"
            PIPED_DB_PASSWORD: "{{ env_vars.HOME_PIPED_DB_PASSWORD }}"

        - name: Deploy Piped
          ansible.builtin.command:
            cmd: docker compose --env-file=../.env up -d
            chdir: "{{ server_path }}/piped"
          register: piped_deploy
          changed_when: "'Started' in piped_deploy.stderr or 'Created' in piped_deploy.stderr"

    # ===== CLOUD SERVER - WAIT FOR SERVICES =====
    - name: Cloud Server - Wait for services
      when: is_cloud_server
      block:
        - name: Wait for mail server
          ansible.builtin.wait_for:
            port: 25
            delay: 5
            timeout: 60

        - name: Wait for Traefik
          ansible.builtin.wait_for:
            port: 443
            delay: 3
            timeout: 30

    # ===== SUMMARY =====
    - name: Get running containers
      community.docker.docker_host_info:
        containers: yes
      register: docker_info

    - name: Display deployment summary - Home Server
      ansible.builtin.debug:
        msg:
          - "✅ Home server deployment completed!"
          - ""
          - "Deployed containers: {{ docker_info.containers | map(attribute='Names') | map('first') | list }}"
          - ""
          - "Access: https://ui.{{ lookup('env', 'HOME_DOMAIN') }}"
      when: is_home_server

    - name: Display deployment summary - Cloud Server
      ansible.builtin.debug:
        msg:
          - "✅ Cloud server deployment completed!"
          - ""
          - "Deployed containers: {{ docker_info.containers | map(attribute='Names') | map('first') | list }}"
          - ""
          - "Next steps:"
          - "  1. Configure DKIM: docker exec mailserver cat /tmp/docker-mailserver/opendkim/keys/*/mail.txt"
          - "  2. Add DKIM to DNS as TXT record: mail._domainkey"
          - "  3. Create email accounts: docker exec -it mailserver setup email add user@domain.com"
          - "  4. Test at: https://www.mail-tester.com"
      when: is_cloud_server

    - name: Display deployment summary - Offsite Server
      ansible.builtin.debug:
        msg:
          - "✅ Offsite server deployment completed!"
          - ""
          - "Deployed containers: {{ docker_info.containers | map(attribute='Names') | map('first') | list }}"
      when: is_offsite_server
