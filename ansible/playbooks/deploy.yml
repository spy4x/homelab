---
# Playbook: Deploy Homelab Services
# This playbook replaces the Makefile deployment process with Ansible
# It builds the homepage, copies files, and deploys Docker services

- name: Deploy Homelab Services
  hosts: homelab_servers

  vars:
    local_repo_path: "{{ playbook_dir }}/../.."
    server_path: "{{ apps_path }}"

  tasks:
    # ===== Build Homepage =====
    - name: Create homepage dist directory locally
      ansible.builtin.file:
        path: "{{ local_repo_path }}/server/homepage/dist"
        state: directory
        mode: "0755"
      delegate_to: localhost

    - name: Load .env file for homepage variables
      ansible.builtin.shell: |
        set -a
        source {{ local_repo_path }}/server/.env
        envsubst < {{ local_repo_path }}/server/homepage/src/index.html > {{ local_repo_path }}/server/homepage/dist/index.html
      args:
        executable: /bin/bash
      delegate_to: localhost
      changed_when: true

    - name: Copy homepage static files
      ansible.builtin.copy:
        src: "{{ local_repo_path }}/server/homepage/src/{{ item }}"
        dest: "{{ local_repo_path }}/server/homepage/dist/{{ item }}"
      loop:
        - sw.js
        - manifest.json
      delegate_to: localhost
    - name: Copy homepage assets
      ansible.builtin.copy:
        src: "{{ local_repo_path }}/server/homepage/src/assets"
        dest: "{{ local_repo_path }}/server/homepage/dist/"
      delegate_to: localhost

    - name: Sync server files to remote
      ansible.posix.synchronize:
        src: "{{ local_repo_path }}/server/"
        dest: "{{ server_path }}/"
        delete: no
        recursive: yes
        rsync_opts:
          - "--include-from={{ local_repo_path }}/server/deploy.files.txt"
          - "--exclude=*"
          - "-avhzru"

    # ===== Docker Network Setup =====
    - name: Create proxy network
      community.docker.docker_network:
        name: proxy
        state: present

    # ===== Deploy Services =====
    - name: Deploy main homelab services
      ansible.builtin.command:
        cmd: docker compose up -d
        chdir: "{{ server_path }}"
      register: homelab_deploy
      changed_when: "'Started' in homelab_deploy.stderr or 'Created' in homelab_deploy.stderr"

    - name: Deploy Immich with multiple env files
      ansible.builtin.command:
        cmd: docker compose --env-file=.env --env-file=../.env up -d
        chdir: "{{ server_path }}/immich"
      register: immich_deploy
      changed_when: "'Started' in immich_deploy.stderr or 'Created' in immich_deploy.stderr"

    # ===== Summary =====
    - name: Get running containers
      community.docker.docker_host_info:
        containers: yes
      register: docker_info

    - name: Display deployment summary
      ansible.builtin.debug:
        msg:
          - "✅ Homelab deployment completed successfully!"
          - ""
          - "Deployed services:"
          - "{{ docker_info.containers | map(attribute='Names') | map('first') | list }}"
          - ""
          - "Changed containers:"
          - "{{ homelab_deploy.actions | default([]) }}"
          - ""
          - "Next steps:"
          - "  • Check services: docker ps"
          - "  • View logs: docker logs <container-name>"
          - "  • Access homepage: https://ui.{{ lookup('env', 'DOMAIN') }}"
