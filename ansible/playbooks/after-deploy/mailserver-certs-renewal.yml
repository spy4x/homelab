---
# Playbook: Setup Mailserver Certificate Renewal Cronjob
# This playbook configures automatic certificate updates for mailserver from Traefik
# Certificates are extracted from Traefik's acme.json and copied to mailserver

- name: Setup Mailserver Certificate Renewal
  hosts: homelab_servers
  become: false # Run as user, not root

  tasks:
    - name: Check if mailserver is deployed
      ansible.builtin.stat:
        path: "{{ apps_path }}/stacks/mailserver/compose.yml"
      register: mailserver_compose

    - name: Skip if mailserver not deployed
      ansible.builtin.meta: end_play
      when: not mailserver_compose.stat.exists

    - name: Ensure extract-certs.sh exists
      ansible.builtin.stat:
        path: "{{ apps_path }}/stacks/mailserver/extract-certs.sh"
      register: extract_certs_script

    - name: Fail if extract-certs.sh doesn't exist
      ansible.builtin.fail:
        msg: "extract-certs.sh not found at {{ apps_path }}/stacks/mailserver/extract-certs.sh"
      when: not extract_certs_script.stat.exists

    - name: Make extract-certs.sh executable
      ansible.builtin.file:
        path: "{{ apps_path }}/stacks/mailserver/extract-certs.sh"
        mode: "0755"

    - name: Copy extract-certs.sh to /tmp (for use by before.deploy.ts)
      ansible.builtin.copy:
        src: "{{ apps_path }}/stacks/mailserver/extract-certs.sh"
        dest: /tmp/extract-certs.sh
        mode: "0755"
        remote_src: true

    - name: Setup certificate renewal cronjob
      ansible.builtin.cron:
        name: "Mailserver Certificate Renewal"
        user: "{{ homelab_user }}"
        minute: "15"
        hour: "3"
        job: "cd {{ apps_path }} && VOLUMES_PATH={{ volumes_path }} bash {{ apps_path }}/stacks/mailserver/extract-certs.sh mail.{{ lookup('env', 'DOMAIN') | default('antonshubin.com', true) }} >> {{ apps_path }}/.logs/mailserver-cert-renewal.log 2>&1"
        state: present

    - name: Create log directory
      ansible.builtin.file:
        path: "{{ apps_path }}/.logs"
        state: directory
        owner: "{{ homelab_user }}"
        group: "{{ homelab_user }}"
        mode: "0755"

    - name: Create log file
      ansible.builtin.file:
        path: "{{ apps_path }}/.logs/mailserver-cert-renewal.log"
        state: touch
        owner: "{{ homelab_user }}"
        group: "{{ homelab_user }}"
        mode: "0644"
        modification_time: preserve
        access_time: preserve

    - name: Display cronjob info
      ansible.builtin.debug:
        msg:
          - "âœ… Mailserver certificate renewal cronjob configured!"
          - "Schedule: Daily at 03:15 (after Let's Encrypt renewal attempts)"
          - "Log file: {{ apps_path }}/.logs/mailserver-cert-renewal.log"
          - "To view logs: tail -f {{ apps_path }}/.logs/mailserver-cert-renewal.log"
          - "To test manually: cd {{ apps_path }} && VOLUMES_PATH={{ volumes_path }} bash {{ apps_path }}/stacks/mailserver/extract-certs.sh mail.{{ lookup('env', 'DOMAIN') | default('antonshubin.com', true) }}"
