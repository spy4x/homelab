name: ${PROJECT}

networks:
  proxy:
    external: true

services:
  # Traefik is a reverse proxy and load balancer.
  # It is used to route incoming requests to the correct container by domain name and not by port.
  # Ex: https://movies.example.com -> jellyfin container:8096
  # Ex: https://gitea.example.com -> gitea container:3000
  # It's configured to use Let's Encrypt to automatically generate SSL certificates and redirect all HTTP requests to HTTPS.
  proxy:
    container_name: "proxy"
    image: "traefik:latest"
    restart: unless-stopped
    command:
      # - "--log.level=DEBUG"
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.websecure.address=:443"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.web.http.redirections.entrypoint.permanent=true"
      # Timeout settings to allow large file uploads to Immich (up to 600s)
      - --entrypoints.websecure.transport.respondingTimeouts.readTimeout=600s
      - --entrypoints.websecure.transport.respondingTimeouts.idleTimeout=600s
      - --entrypoints.websecure.transport.respondingTimeouts.writeTimeout=600s
      # - "--certificatesresolvers.myresolver.acme.tlschallenge=true"
      - "--certificatesresolvers.myresolver.acme.httpchallenge=true" # Use HTTP-01 challenge
      - "--certificatesresolvers.myresolver.acme.httpchallenge.entrypoint=web" # Use 'web' entrypoint (port 80) for the challenge
      # - "--certificatesresolvers.myresolver.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory" # Use staging server for testing
      - "--certificatesresolvers.myresolver.acme.email=${CONTACT_EMAIL}"
      - "--certificatesresolvers.myresolver.acme.storage=/letsencrypt/acme.json"
    ports:
      - 443:443
      - 80:80
    volumes:
      - "./.volumes/traefik/letsencrypt:/letsencrypt"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
    networks:
      - proxy
      - default
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 1024M
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.services.traefik.loadbalancer.server.port=8080"
      - "traefik.http.routers.traefik.rule=Host(`proxy.${DOMAIN}`)"
      - "traefik.http.routers.traefik.entrypoints=websecure"
      - "traefik.http.routers.traefik.tls=true"
      - "traefik.http.routers.traefik.tls.certresolver=myresolver"
      - "traefik.http.routers.traefik.middlewares=auth"
      - "traefik.http.middlewares.auth.basicauth.users=${BASIC_AUTH_USER}:${BASIC_AUTH_PASSWORD}"

  # Uptime Kuma is a monitoring tool, that checks the status of your websites and APIs.
  uptime-kuma:
    container_name: uptime-kuma
    image: louislam/uptime-kuma
    volumes:
      - ./.volumes/uptime-kuma:/app/data
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.25"
    security_opt:
      - no-new-privileges:true
    networks:
      - proxy
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.services.uptime-kuma.loadbalancer.server.port=3001"
      - "traefik.http.routers.uptime-kuma.rule=Host(`uptime.${DOMAIN}`)"
      - "traefik.http.routers.uptime-kuma.entrypoints=websecure"
      - "traefik.http.routers.uptime-kuma.tls=true"
      - "traefik.http.routers.uptime-kuma.tls.certresolver=myresolver"

  # Transmission is a BitTorrent client with a web interface.
  # It is a lightweight, works on the server in background and has zero configuration.
  transmission:
    image: linuxserver/transmission
    container_name: transmission
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TIMEZONE}
    volumes:
      - ./.volumes/transmission:/config
      - ${PATH_MOVIES}:/downloads/movies
      - ${PATH_SERIES}:/downloads/series
      - ${PATH_MUSIC}:/downloads/music
      - ${PATH_BOOKS}:/downloads/books
      - ${PATH_OTHER}:/downloads/other
    ports:
      - 51413:51413 # Default port for torrent traffic
      - 51413:51413/udp # Default port for DHT
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2048M
          cpus: "1"
    security_opt:
      - no-new-privileges:true
    networks:
      - proxy
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.services.transmission.loadbalancer.server.port=9091"
      - "traefik.http.routers.transmission.rule=Host(`torrents.${DOMAIN}`)"
      - "traefik.http.routers.transmission.entrypoints=websecure"
      - "traefik.http.routers.transmission.tls=true"
      - "traefik.http.routers.transmission.tls.certresolver=myresolver"
      - "traefik.http.routers.transmission.middlewares=auth"

  # Jellyfin is a media server for hosting and managing personal media libraries.
  # Think of movies, TV shows, home videos, music, and pictures.
  jellyfin:
    container_name: jellyfin
    image: jellyfin/jellyfin
    volumes:
      - ./.volumes/jellyfin:/config
      - ./.volumes/jellyfin-cache:/cache
      - ${PATH_MEDIA}:/media
      - ${PATH_VIDEOS}:/videos
      - ${PATH_MUSIC}:/music
    devices:
      - /dev/dri:/dev/dri # for GPU transcoding
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 8192M
          cpus: "3"
    security_opt:
      - no-new-privileges:true
    networks:
      - proxy
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.services.jellyfin.loadbalancer.server.port=8096"
      - "traefik.http.routers.jellyfin.rule=Host(`movies.${DOMAIN}`)"
      - "traefik.http.routers.jellyfin.entrypoints=websecure"
      - "traefik.http.routers.jellyfin.tls=true"
      - "traefik.http.routers.jellyfin.tls.certresolver=myresolver"

  # A simple HTML page to display links to all the services.
  homepage:
    container_name: homepage
    image: nginx:alpine
    volumes:
      - ./homepage/dist:/usr/share/nginx/html:ro
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: "0.10"
    security_opt:
      - no-new-privileges:true
    networks:
      - proxy
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.services.homepage.loadbalancer.server.port=80"
      - "traefik.http.routers.homepage.rule=Host(`ui.${DOMAIN}`)"
      - "traefik.http.routers.homepage.entrypoints=websecure"
      - "traefik.http.routers.homepage.tls=true"
      - "traefik.http.routers.homepage.tls.certresolver=myresolver"

  # Vaultwarden is a password manager which is compatible with Bitwarden clients.
  vaultwarden:
    container_name: vaultwarden
    image: vaultwarden/server:latest
    user: "1000:1000" # Run as non-root user for better security
    environment:
      - DOMAIN=https://passwords.${DOMAIN}
      # - ADMIN_TOKEN=${VAULTWARDEN_ADMIN_TOKEN} # Enable admin page only while needed and disable otherwise for better security
      - SIGNUPS_ALLOWED=${VAULTWARDEN_SIGNUPS_ALLOWED}
      - INVITATIONS_ALLOWED=${VAULTWARDEN_INVITATIONS_ALLOWED}
      - SHOW_PASSWORD_HINT=${VAULTWARDEN_SHOW_PASSWORD_HINT}
      - LOGIN_RATELIMIT_MAX_BURST=${VAULTWARDEN_LOGIN_RATELIMIT_MAX_BURST}
      - LOGIN_RATELIMIT_SECONDS=${VAULTWARDEN_LOGIN_RATELIMIT_SECONDS}
      - INCOMPLETE_2FA_TIME_LIMIT=${VAULTWARDEN_INCOMPLETE_2FA_TIME_LIMIT}
      - LOG_LEVEL=${VAULTWARDEN_LOG_LEVEL}
      - EMERGENCY_ACCESS_ALLOWED=${VAULTWARDEN_EMERGENCY_ACCESS_ALLOWED}
      # Real client IP from Cloudflare (enables proper logging and rate limiting)
      - IP_HEADER=CF-Connecting-IP
    volumes:
      - ./.volumes/vaultwarden:/data
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
    security_opt:
      - no-new-privileges:true
    networks:
      - proxy
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      # Main service (handles both HTTP and WebSocket on port 80 since v1.29.0)
      - "traefik.http.services.vaultwarden.loadbalancer.server.port=80"
      - "traefik.http.routers.vaultwarden.rule=Host(`passwords.${DOMAIN}`)"
      - "traefik.http.routers.vaultwarden.entrypoints=websecure"
      - "traefik.http.routers.vaultwarden.tls=true"
      - "traefik.http.routers.vaultwarden.tls.certresolver=myresolver"
      - "traefik.http.routers.vaultwarden.service=vaultwarden"
      # Cloudflare real IP middleware
      - "traefik.http.routers.vaultwarden.middlewares=vaultwarden-realip"
      - "traefik.http.middlewares.vaultwarden-realip.headers.customrequestheaders.CF-Connecting-IP="

  # Watchtower is a process for automating Docker container base image updates.
  watchtower:
    container_name: watchtower
    image: containrrr/watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 2048M
    security_opt:
      - no-new-privileges:true
    command: --interval 86400 --cleanup

  wireguard:
    container_name: wireguard
    image: lscr.io/linuxserver/wireguard:latest
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TIMEZONE}
      - SERVERURL=vpn.${DOMAIN}
      - SERVERPORT=51820
      - PEERS=${VPN_PEERS}
      - PEERDNS=1.1.1.1,8.8.8.8,9.9.9.9
      - LOG_CONFS=true
    volumes:
      - ./.volumes/wireguard:/config
      - /lib/modules:/lib/modules:ro
    ports:
      - 51820:51820/udp
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "1"
          memory: 512M
    security_opt:
      - no-new-privileges:true
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1

  syncthing:
    container_name: syncthing
    image: syncthing/syncthing:latest
    volumes:
      - ./.volumes/syncthing:/var/syncthing
      - /etc/localtime:/etc/localtime:ro
      - ${PATH_SYNC}:/sync
      - ${PATH_VIDEOS}/watch-later:/yt-watch-later
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4096M
          cpus: "3"
    security_opt:
      - no-new-privileges:true
    networks:
      - proxy
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.services.syncthing.loadbalancer.server.port=8384"
      - "traefik.http.routers.syncthing.rule=Host(`sync.${DOMAIN}`)"
      - "traefik.http.routers.syncthing.entrypoints=websecure"
      - "traefik.http.routers.syncthing.tls=true"
      - "traefik.http.routers.syncthing.tls.certresolver=myresolver"

  open-webui:
    container_name: open-webui
    image: ghcr.io/open-webui/open-webui:latest
    restart: unless-stopped
    volumes:
      - ./.volumes/open-webui:/app/backend/data
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
    networks:
      - proxy
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.services.open-webui.loadbalancer.server.port=8080"
      - "traefik.http.routers.open-webui.rule=Host(`ai.${DOMAIN}`)"
      - "traefik.http.routers.open-webui.entrypoints=websecure"
      - "traefik.http.routers.open-webui.tls=true"
      - "traefik.http.routers.open-webui.tls.certresolver=myresolver"

  # Audiobookshelf is a self-hosted audio & epub/pdf book server.
  audiobookshelf:
    container_name: audiobookshelf
    image: ghcr.io/advplyr/audiobookshelf:latest
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TIMEZONE}
    volumes:
      - ./.volumes/audiobookshelf/config:/config
      - ./.volumes/audiobookshelf-metadata:/metadata
      - ${PATH_BOOKS}:/audiobooks
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1024M
          cpus: "1"
    security_opt:
      - no-new-privileges:true
    networks:
      - proxy
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.services.audiobookshelf.loadbalancer.server.port=80"
      - "traefik.http.routers.audiobookshelf.rule=Host(`books.${DOMAIN}`)"
      - "traefik.http.routers.audiobookshelf.entrypoints=websecure"
      - "traefik.http.routers.audiobookshelf.tls=true"
      - "traefik.http.routers.audiobookshelf.tls.certresolver=myresolver"

  # MeTube is a web GUI for youtube-dl with playlist support.
  # It allows you to download videos from YouTube and other supported sites.
  metube:
    container_name: metube
    image: ghcr.io/alexta69/metube
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TIMEZONE}
      - DOWNLOAD_DIR=/downloads/videos
      - AUDIO_DOWNLOAD_DIR=/downloads/music
      - OUTPUT_TEMPLATE=%(uploader,channel)s/%(title)s.%(ext)s
      - OUTPUT_TEMPLATE_PLAYLIST=%(playlist,uploader,channel)s/%(title)s.%(ext)s
    volumes:
      - ${PATH_VIDEOS}:/downloads/videos
      - ${PATH_MUSIC}:/downloads/music
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
    security_opt:
      - no-new-privileges:true
    networks:
      - proxy
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.services.metube.loadbalancer.server.port=8081"
      - "traefik.http.routers.metube.rule=Host(`metube.${DOMAIN}`)"
      - "traefik.http.routers.metube.entrypoints=websecure"
      - "traefik.http.routers.metube.tls=true"
      - "traefik.http.routers.metube.tls.certresolver=myresolver"
      - "traefik.http.routers.metube.middlewares=auth"

  # Home Assistant is a home automation platform that focuses on privacy and local control.
  # It allows you to control all your devices from a single, mobile-friendly interface.
  home-assistant:
    container_name: home-assistant
    image: ghcr.io/home-assistant/home-assistant:stable
    volumes:
      - ./.volumes/home-assistant:/config
      - /etc/localtime:/etc/localtime:ro
    devices:
      - /dev/ttyUSB0:/dev/ttyUSB0  # Zigbee USB dongle
    environment:
      - TZ=${TIMEZONE}
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2048M
          cpus: "2"
    security_opt:
      - no-new-privileges:true
    networks:
      - proxy
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.services.home-assistant.loadbalancer.server.port=8123"
      - "traefik.http.routers.home-assistant.rule=Host(`home.${DOMAIN}`)"
      - "traefik.http.routers.home-assistant.entrypoints=websecure"
      - "traefik.http.routers.home-assistant.tls=true"
      - "traefik.http.routers.home-assistant.tls.certresolver=myresolver"

  # YouTube downloader for my watch later list.
  yt-watch-later-downloader:
    image: jauderho/yt-dlp:latest
    container_name: yt-watch-later-downloader
    user: "1000:1000" 
    entrypoint: /bin/sh
    command: 
      - -c
      - |
        while true; do
          yt-dlp --download-archive /config/yt-archive.txt -o '/downloads/%(title)s.%(ext)s' -f 'bestvideo[height<=1080][ext=webm]+bestaudio[ext=webm]/best[height<=1080][ext=mp4]/best[height<=1080]' --merge-output-format mkv --sleep-requests 1 --sleep-interval 5 --max-sleep-interval 30 --no-continue '${YOUTUBE_WATCH_LATER_PLAYLIST_URL}';
          echo "Sleeping for 1 hour before checking the playlist again...";
          sleep 3600;
        done
    volumes:
      - ./.volumes/yt-watch-later-downloader:/config:Z
      - ${PATH_VIDEOS}/watch-later:/downloads:Z
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 4096M

  # ntfy is a simple HTTP-based pub-sub notification service.
  # It allows you to send push notifications to your phone or desktop via scripts.
  # Configured with authentication - only authorized users can publish/subscribe.
  # User management: https://docs.ntfy.sh/config/#users-and-roles
  ntfy:
    container_name: ntfy
    image: binwiederhier/ntfy
    command:
      - serve
    environment:
      - TZ=${TIMEZONE}
      - NTFY_BASE_URL=https://ntfy.${DOMAIN}
      - NTFY_UPSTREAM_BASE_URL=https://ntfy.sh
      - NTFY_CACHE_FILE=/var/lib/ntfy/cache.db
      - NTFY_AUTH_FILE=/var/lib/ntfy/auth.db
      - NTFY_ATTACHMENT_CACHE_DIR=/var/lib/ntfy/attachments
      - NTFY_AUTH_DEFAULT_ACCESS=deny-all
      - NTFY_BEHIND_PROXY=true
      - NTFY_ENABLE_SIGNUP=false
      - NTFY_ENABLE_LOGIN=true
    user: "1000:1000"
    volumes:
      - ./.volumes/ntfy/cache:/var/lib/ntfy
      - ./.volumes/ntfy/etc:/etc/ntfy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
    security_opt:
      - no-new-privileges:true
    networks:
      - proxy
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.services.ntfy.loadbalancer.server.port=80"
      - "traefik.http.routers.ntfy.rule=Host(`ntfy.${DOMAIN}`)"
      - "traefik.http.routers.ntfy.entrypoints=websecure"
      - "traefik.http.routers.ntfy.tls=true"
      - "traefik.http.routers.ntfy.tls.certresolver=myresolver"

  # AdGuard Home is a network-wide ad and tracker blocker that also functions as a DNS server.
  # It provides DNS-level ad blocking, tracker blocking, and parental control features.
  # Access the web interface to configure DNS settings, filters, and view statistics.
  adguard:
    container_name: adguard
    image: adguard/adguardhome:latest
    volumes:
      - ./.volumes/adguard/work:/opt/adguardhome/work
      - ./.volumes/adguard/conf:/opt/adguardhome/conf
    ports:
      - 53:53/tcp      # DNS
      - 53:53/udp      # DNS
      - 853:853/tcp    # DNS-over-TLS
      # - 3000:3000/tcp  # Initial setup web interface (can be disabled after setup)
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "3"
    security_opt:
      - no-new-privileges:true
    networks:
      - proxy
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.services.adguard.loadbalancer.server.port=80"
      - "traefik.http.routers.adguard.rule=Host(`dns.${DOMAIN}`)"
      - "traefik.http.routers.adguard.entrypoints=websecure"
      - "traefik.http.routers.adguard.tls=true"
      - "traefik.http.routers.adguard.tls.certresolver=myresolver"

  # FileBrowser is a web-based file manager that provides a simple interface for managing files.
  # It allows you to upload, download, edit, and organize files through a web interface.
  filebrowser:
    container_name: filebrowser
    image: filebrowser/filebrowser:latest
    user: "1000:1000"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TIMEZONE}
    volumes:
      - ./.volumes/filebrowser:/database
      - ${PATH_MEDIA}:/srv/media
      - ${PATH_VIDEOS}:/srv/videos
      - ${PATH_MUSIC}:/srv/music
      - ${PATH_BOOKS}:/srv/books
      - ${PATH_SYNC}:/srv/sync
      - ${PATH_MOVIES}:/srv/movies
      - ${PATH_SERIES}:/srv/series
      - ${PATH_OTHER}:/srv/other
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
    security_opt:
      - no-new-privileges:true
    networks:
      - proxy
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.services.filebrowser.loadbalancer.server.port=80"
      - "traefik.http.routers.filebrowser.rule=Host(`files.${DOMAIN}`)"
      - "traefik.http.routers.filebrowser.entrypoints=websecure"
      - "traefik.http.routers.filebrowser.tls=true"
      - "traefik.http.routers.filebrowser.tls.certresolver=myresolver"

  # FreshRSS is a self-hosted RSS feed aggregator.
  # It allows you to follow your favorite websites and stay updated with new content.
  freshrss:
    container_name: freshrss
    image: lscr.io/linuxserver/freshrss:latest
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=${TIMEZONE}
    volumes:
      - ./.volumes/freshrss:/config:Z
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
    security_opt:
      - no-new-privileges:true
    networks:
      - proxy
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.services.freshrss.loadbalancer.server.port=80"
      - "traefik.http.routers.freshrss.rule=Host(`rss.${DOMAIN}`)"
      - "traefik.http.routers.freshrss.entrypoints=websecure"
      - "traefik.http.routers.freshrss.tls=true"
      - "traefik.http.routers.freshrss.tls.certresolver=myresolver"

  # Radicale is a lightweight CalDAV and CardDAV server for calendars, contacts, and tasks.
  # It provides a simple interface for syncing your calendar and contacts across devices.
  radicale:
    container_name: radicale
    image: tomsquest/docker-radicale:latest
    user: "1000:1000"
    environment:
      - TZ=${TIMEZONE}
    volumes:
      - ./.volumes/radicale/data:/data
      - ./.volumes/radicale/config:/config
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.25"
    security_opt:
      - no-new-privileges:true
    networks:
      - proxy
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.services.radicale.loadbalancer.server.port=5232"
      - "traefik.http.routers.radicale.rule=Host(`cal.${DOMAIN}`)"
      - "traefik.http.routers.radicale.entrypoints=websecure"
      - "traefik.http.routers.radicale.tls=true"
      - "traefik.http.routers.radicale.tls.certresolver=myresolver"

  # Woodpecker CI is a lightweight, self-hosted CI/CD platform.
  # It provides automated testing and deployment pipelines for your repositories.
  # Note: You need to configure WOODPECKER_GITEA_URL, WOODPECKER_GITEA_CLIENT, and WOODPECKER_GITEA_SECRET
  # or use GitHub/GitLab integration by setting the appropriate environment variables.
  woodpecker-server:
    container_name: woodpecker-server
    image: woodpeckerci/woodpecker-server:v3.11.0
    environment:
      - WOODPECKER_OPEN=true
      - WOODPECKER_HOST=https://ci.${DOMAIN}
      - WOODPECKER_AGENT_SECRET=${WOODPECKER_AGENT_SECRET}
      # GitHub integration (comment out if using Gitea/GitLab)
      - WOODPECKER_GITHUB=true
      - WOODPECKER_GITHUB_CLIENT=${WOODPECKER_GITHUB_CLIENT}
      - WOODPECKER_GITHUB_SECRET=${WOODPECKER_GITHUB_SECRET}
      # Uncomment for Gitea integration
      # - WOODPECKER_GITEA=true
      # - WOODPECKER_GITEA_URL=${WOODPECKER_GITEA_URL}
      # - WOODPECKER_GITEA_CLIENT=${WOODPECKER_GITEA_CLIENT}
      # - WOODPECKER_GITEA_SECRET=${WOODPECKER_GITEA_SECRET}
      # Uncomment for GitLab integration
      # - WOODPECKER_GITLAB=true
      # - WOODPECKER_GITLAB_URL=${WOODPECKER_GITLAB_URL}
      # - WOODPECKER_GITLAB_CLIENT=${WOODPECKER_GITLAB_CLIENT}
      # - WOODPECKER_GITLAB_SECRET=${WOODPECKER_GITLAB_SECRET}
      - WOODPECKER_ADMIN=${WOODPECKER_ADMIN}
    volumes:
      - ./.volumes/woodpecker-server:/var/lib/woodpecker
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1"
    security_opt:
      - no-new-privileges:true
    networks:
      - proxy
      - default
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=proxy"
      - "traefik.http.services.woodpecker.loadbalancer.server.port=8000"
      - "traefik.http.routers.woodpecker.rule=Host(`ci.${DOMAIN}`)"
      - "traefik.http.routers.woodpecker.entrypoints=websecure"
      - "traefik.http.routers.woodpecker.tls=true"
      - "traefik.http.routers.woodpecker.tls.certresolver=myresolver"

  woodpecker-agent:
    container_name: woodpecker-agent
    image: woodpeckerci/woodpecker-agent:v3.11.0
    environment:
      - WOODPECKER_SERVER=woodpecker-server:9000
      - WOODPECKER_AGENT_SECRET=${WOODPECKER_AGENT_SECRET}
      - WOODPECKER_BACKEND=docker
      - WOODPECKER_MAX_WORKFLOWS=4  # Parallel workflows
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./.volumes/woodpecker-agent/cache:/woodpecker/cache  # Cache for faster builds
    depends_on:
      - woodpecker-server
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 8192M  # Increased for Deno+Vite+Hono monorepos
          cpus: "4"      # More CPU for parallel builds
    security_opt:
      - no-new-privileges:true
