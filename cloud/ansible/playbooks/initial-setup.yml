---
# Playbook: Initial Cloud Server Setup
# This playbook configures a fresh Hetzner VPS for mail server hosting
# Run this once after creating the VPS

- name: Initial Cloud Server Setup
  hosts: cloud_servers
  become: true

  vars:
    docker_gpg_url: "https://download.docker.com/linux/{{ ansible_distribution | lower }}/gpg"
    docker_repo_url: "https://download.docker.com/linux/{{ ansible_distribution | lower }}"

  tasks:
    # ===== System Update =====
    - name: Update package cache (Debian/Ubuntu)
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Update package cache (RedHat/Fedora)
      ansible.builtin.dnf:
        update_cache: yes
      when: ansible_os_family == "RedHat"

    - name: Upgrade all packages
      ansible.builtin.package:
        name: "*"
        state: latest
      when: ansible_os_family == "RedHat"

    # ===== Essential Packages =====
    - name: Install essential packages (Debian/Ubuntu)
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
          - git
          - vim
          - htop
          - tmux
          - unzip
          - restic
          - httpd-tools
          - fail2ban
          - ufw
        state: present
      when: ansible_os_family == "Debian"

    - name: Install essential packages (RedHat/Fedora)
      ansible.builtin.dnf:
        name:
          - ca-certificates
          - curl
          - gnupg
          - git
          - vim
          - htop
          - tmux
          - unzip
          - restic
          - httpd-tools
          - fail2ban
          - firewalld
        state: present
      when: ansible_os_family == "RedHat"

    # ===== Docker Installation =====
    - name: Check if Docker is already installed
      ansible.builtin.command: docker --version
      register: docker_check
      failed_when: false
      changed_when: false

    - name: Install Docker using get.docker.com script
      ansible.builtin.shell: |
        curl -fsSL https://get.docker.com -o /tmp/get-docker.sh
        sh /tmp/get-docker.sh
        rm /tmp/get-docker.sh
      when: docker_check.rc != 0
      args:
        creates: /usr/bin/docker

    - name: Create cloud user
      ansible.builtin.user:
        name: "{{ homelab_user }}"
        groups: docker
        append: yes
        shell: /bin/bash
        create_home: yes

    - name: Enable Docker service
      ansible.builtin.systemd:
        name: docker
        enabled: yes
        state: started

    - name: Install Docker Compose plugin
      ansible.builtin.shell: |
        DOCKER_CONFIG=${DOCKER_CONFIG:-/usr/local/lib/docker}
        mkdir -p $DOCKER_CONFIG/cli-plugins
        curl -SL https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64 -o $DOCKER_CONFIG/cli-plugins/docker-compose
        chmod +x $DOCKER_CONFIG/cli-plugins/docker-compose
      args:
        creates: /usr/local/lib/docker/cli-plugins/docker-compose

    # ===== Deno Installation =====
    - name: Check if Deno is already installed
      ansible.builtin.stat:
        path: "{{ deno_install_path }}/bin/deno"
      register: deno_installed

    - name: Install Deno
      ansible.builtin.shell: |
        curl -fsSL https://deno.land/install.sh | sh
      environment:
        DENO_INSTALL: "{{ deno_install_path }}"
      become_user: "{{ homelab_user }}"
      when: not deno_installed.stat.exists

    - name: Add Deno to PATH in .bashrc
      ansible.builtin.lineinfile:
        path: "/home/{{ homelab_user }}/.bashrc"
        line: 'export PATH="{{ deno_install_path }}/bin:$PATH"'
        state: present
        create: yes
      become_user: "{{ homelab_user }}"

    # ===== Firewall Configuration =====
    - name: Configure firewall (Debian/Ubuntu - ufw)
      block:
        - name: Enable ufw
          community.general.ufw:
            state: enabled
            policy: deny

        - name: Allow SSH
          community.general.ufw:
            rule: allow
            port: '22'
            proto: tcp

        - name: Allow HTTP
          community.general.ufw:
            rule: allow
            port: '80'
            proto: tcp

        - name: Allow HTTPS
          community.general.ufw:
            rule: allow
            port: '443'
            proto: tcp

        - name: Allow SMTP
          community.general.ufw:
            rule: allow
            port: '25'
            proto: tcp

        - name: Allow SMTP Submission
          community.general.ufw:
            rule: allow
            port: '587'
            proto: tcp

        - name: Allow SMTPS
          community.general.ufw:
            rule: allow
            port: '465'
            proto: tcp

        - name: Allow IMAPS
          community.general.ufw:
            rule: allow
            port: '993'
            proto: tcp
      when: ansible_os_family == "Debian"

    - name: Configure firewall (RedHat/Fedora - firewalld)
      block:
        - name: Enable firewalld
          ansible.builtin.systemd:
            name: firewalld
            enabled: yes
            state: started

        - name: Allow HTTP
          ansible.posix.firewalld:
            service: http
            permanent: yes
            state: enabled

        - name: Allow HTTPS
          ansible.posix.firewalld:
            service: https
            permanent: yes
            state: enabled

        - name: Allow SMTP
          ansible.posix.firewalld:
            service: smtp
            permanent: yes
            state: enabled

        - name: Allow SMTP Submission
          ansible.posix.firewalld:
            service: smtp-submission
            permanent: yes
            state: enabled

        - name: Allow SMTPS
          ansible.posix.firewalld:
            service: smtps
            permanent: yes
            state: enabled

        - name: Allow IMAPS
          ansible.posix.firewalld:
            service: imaps
            permanent: yes
            state: enabled

        - name: Reload firewalld
          ansible.builtin.command: firewall-cmd --reload
      when: ansible_os_family == "RedHat"

    # ===== Directory Structure =====
    - name: Create apps directory structure
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ homelab_user }}"
        group: "{{ homelab_user }}"
        mode: "0755"
      loop:
        - "{{ apps_path }}"
        - "{{ apps_path }}/.volumes"
        - "{{ apps_path }}/scripts"

    # ===== Summary =====
    - name: Get Docker version
      ansible.builtin.command: docker --version
      register: docker_version
      changed_when: false

    - name: Get Deno version
      ansible.builtin.command: "{{ deno_install_path }}/bin/deno --version"
      register: deno_version
      changed_when: false
      become_user: "{{ homelab_user }}"

    - name: Display setup summary
      ansible.builtin.debug:
        msg:
          - "âœ… Cloud server initial setup completed!"
          - ""
          - "Installed components:"
          - "  - {{ docker_version.stdout }}"
          - "  - Deno {{ deno_version.stdout_lines[0] }}"
          - "  - Restic (backup tool)"
          - "  - Fail2ban (brute force protection)"
          - ""
          - "Configured:"
          - "  - User '{{ homelab_user }}' created with docker access"
          - "  - Firewall configured for mail server"
          - "  - Apps directory created at {{ apps_path }}"
          - ""
          - "Firewall rules:"
          - "  - SSH (22), HTTP (80), HTTPS (443)"
          - "  - SMTP (25), Submission (587), SMTPS (465)"
          - "  - IMAPS (993)"
          - ""
          - "Next steps:"
          - "  1. Update DNS records (see README.md)"
          - "  2. Copy .env.example to .env and configure"
          - "  3. Run 'ansible-playbook playbooks/deploy.yml'"
          - "  4. Configure DKIM (see README.md)"
